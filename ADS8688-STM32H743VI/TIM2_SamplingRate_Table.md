# STM32H743VI TIM2采样率配置表

## 系统时钟配置
- **SYSCLK**: 480MHz
- **AHB**: 240MHz  
- **APB1**: 120MHz
- **TIM2时钟**: 240MHz (APB1×2，因为APB1预分频≠1)

## 采样率计算公式
```
采样率 = TIM2时钟 / [(Prescaler+1) × (Period+1)]
采样率 = 240,000,000 / [(PSC+1) × (ARR+1)]
```

## CubeMX TIM2设置与采样率对应表

### 高精度配置方案对比

#### 方案A：低PSC高精度配置 (推荐)
**优势**: 更高精度、更多中间值选择、更好的时间分辨率

| Prescaler (PSC) | Counter Period (ARR) | 计数频率 (Hz) | 采样率 (Hz) | 采样率 (kHz) | 采样间隔 (μs) | 精度 (ns) | 应用场景 |
|:---------------:|:-------------------:|:-------------:|:-----------:|:------------:|:-------------:|:---------:|:--------:|
| 47 | 49 | 10,000,000 | 100,000 | 100.0 | 10.0 | 100 | 超高速采集(只支持1通道) |
| 47 | 99 | 5,000,000 | 50,000 | 50.0 | 20.0 | 200 | **推荐替代当前** |
| 47 | 199 | 5,000,000 | 25,000 | 25.0 | 40.0 | 200 | 高精度中速 |
| 47 | 499 | 5,000,000 | 10,000 | 10.0 | 100.0 | 200 | 音频采集 |
| 47 | 999 | 5,000,000 | 5,000 | 5.0 | 200.0 | 200 | 高精度语音 |
| 47 | 4999 | 5,000,000 | 1,000 | 1.0 | 1,000.0 | 200 | 高精度控制 |

#### 方案B：传统配置 (当前方案)
**特点**: 较低功耗、简单配置

| Prescaler (PSC) | Counter Period (ARR) | 计数频率 (Hz) | 采样率 (Hz) | 采样率 (kHz) | 采样间隔 (μs) | 精度 (μs) | 应用场景 |
|:---------------:|:-------------------:|:-------------:|:-----------:|:------------:|:-------------:|:---------:|:--------:|
| 479 | 4 | 500,000 | 96,000 | 96.0 | 10.4 | 2.0 | 高速信号采集 |
| 479 | 9 | 500,000 | 50,000 | 50.0 | 20.0 | 2.0 | **当前配置** |
| 479 | 19 | 500,000 | 25,000 | 25.0 | 40.0 | 2.0 | 中高速采集 |
| 479 | 39 | 500,000 | 12,500 | 12.5 | 80.0 | 2.0 | 音频采集 |
| 479 | 49 | 500,000 | 10,000 | 10.0 | 100.0 | 2.0 | 标准音频 |
| 479 | 99 | 500,000 | 5,000 | 5.0 | 200.0 | 2.0 | 语音采集 |
| 479 | 199 | 500,000 | 2,500 | 2.5 | 400.0 | 2.0 | 控制信号 |
| 479 | 499 | 500,000 | 1,000 | 1.0 | 1,000.0 | 2.0 | 慢速监控 |

### 高采样率配置 (1kHz - 100kHz)

### 中等采样率配置 (100Hz - 1kHz)

| Prescaler (PSC) | Counter Period (ARR) | 计数频率 (Hz) | 采样率 (Hz) | 采样率 (kHz) | 采样间隔 (ms) | 应用场景 |
|:---------------:|:-------------------:|:-------------:|:-----------:|:------------:|:-------------:|:--------:|
| 2399 | 99 | 100,000 | 1,000 | 1.0 | 1.0 | 快速控制 |
| 2399 | 199 | 100,000 | 500 | 0.5 | 2.0 | 传感器采集 |
| 2399 | 499 | 100,000 | 200 | 0.2 | 5.0 | 环境监测 |
| 2399 | 999 | 100,000 | 100 | 0.1 | 10.0 | 温度监测 |
| 4799 | 199 | 50,000 | 250 | 0.25 | 4.0 | 慢速控制 |
| 4799 | 499 | 50,000 | 100 | 0.1 | 10.0 | 数据记录 |

### 低采样率配置 (1Hz - 100Hz)

| Prescaler (PSC) | Counter Period (ARR) | 计数频率 (Hz) | 采样率 (Hz) | 采样间隔 (s) | 应用场景 |
|:---------------:|:-------------------:|:-------------:|:-----------:|:------------:|:--------:|
| 23999 | 99 | 10,000 | 100 | 0.01 | 系统监控 |
| 23999 | 199 | 10,000 | 50 | 0.02 | 电池监测 |
| 23999 | 999 | 10,000 | 10 | 0.1 | 长期监控 |
| 23999 | 9999 | 10,000 | 1 | 1.0 | 定时记录 |
| 239999 | 99 | 1,000 | 10 | 0.1 | 环境数据 |
| 239999 | 999 | 1,000 | 1 | 1.0 | 状态检查 |

## 常用采样率快速配置

### 标准音频采样率
```
44.1kHz: PSC=479, ARR=10 (实际: 45.45kHz)
22.05kHz: PSC=479, ARR=21 (实际: 22.73kHz)
8kHz: PSC=479, ARR=61 (实际: 8.06kHz)
```

### 控制系统采样率
```
1kHz: PSC=479, ARR=499 (实际: 1kHz)
100Hz: PSC=2399, ARR=999 (实际: 100Hz)
10Hz: PSC=23999, ARR=999 (实际: 10Hz)
1Hz: PSC=239999, ARR=999 (实际: 1Hz)
```

### ADS8688推荐配置
考虑到ADS8688的性能特点：

| 通道数 | 推荐采样率 | PSC | ARR | 说明 |
|:------:|:----------:|:---:|:---:|:----:|
| 1通道 | 100kHz | 479 | 1 | 单通道最高速 |
| 2通道 | 50kHz | 479 | 9 | **当前配置** |
| 4通道 | 25kHz | 479 | 19 | 中速多通道 |
| 8通道 | 12.5kHz | 479 | 39 | 全通道采集 |

## 注意事项
1. **最大采样率限制**: 受SPI通信速度和ADS8688转换时间限制
2. **实际采样率**: 可能受主循环处理时间影响
3. **缓冲区考虑**: 高采样率需要更大的缓冲区或更频繁的数据处理
4. **精度vs速度**: 高采样率可能影响系统其他功能的响应

## CubeMX配置步骤
1. 打开CubeMX项目
2. 选择 Timers → TIM2
3. 设置 Clock Source: Internal Clock
4. 设置 Prescaler (PSC-16 bit value): 根据表格选择
5. 设置 Counter Period (ARR-AutoReload): 根据表格选择
6. 启用 TIM2 global interrupt
7. 生成代码

## 验证采样率的方法
```c
// 在定时器中断中切换GPIO，用示波器测量
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
    if (htim->Instance == TIM2) 
    {
        HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5); // 示波器测量引脚
        // 正常采样代码...
    }
}
```

## 精度提升分析

### 为什么低PSC高ARR配置更好？

#### 时间分辨率对比
```
方案A (低PSC): PSC=47, ARR=99
- 计数频率 = 240MHz / (47+1) = 5MHz
- 时间分辨率 = 1/5MHz = 200ns

方案B (高PSC): PSC=479, ARR=9  
- 计数频率 = 240MHz / (479+1) = 500kHz
- 时间分辨率 = 1/500kHz = 2μs
```

#### 精度提升 = 2μs / 200ns = 10倍！

### 配置灵活性对比

#### 50kHz采样率的可选配置
| 方案 | PSC | ARR | 计数频率 | 可调节范围 | 最小步进 |
|:----:|:---:|:---:|:--------:|:----------:|:--------:|
| 高精度 | 47 | 99 | 5MHz | 1-100步 | 50Hz |
| 传统 | 479 | 9 | 500kHz | 1-10步 | 5kHz |

**结论**: 高精度方案提供20倍的调节精度！

### 实际应用示例

#### 音频采样率精确配置
```
目标: 44.1kHz采样率

方案A (高精度):
PSC=47, ARR=112 → 实际采样率 = 5MHz/113 = 44.25kHz (误差: 0.34%)

方案B (传统):  
PSC=479, ARR=10 → 实际采样率 = 500kHz/11 = 45.45kHz (误差: 3.06%)
```

#### 控制系统精确时序
```
目标: 1kHz控制周期

方案A (高精度):
PSC=47, ARR=4999 → 实际频率 = 5MHz/5000 = 1000Hz (误差: 0%)

方案B (传统):
PSC=479, ARR=499 → 实际频率 = 500kHz/500 = 1000Hz (误差: 0%)
```

### 推荐配置升级方案

#### 从当前配置升级到高精度
```c
// 当前配置 (tim.c)
htim2.Init.Prescaler = 479;    // 改为: 47
htim2.Init.Period = 10-1;      // 改为: 100-1 (ARR=99)

// 结果: 保持50kHz采样率，精度提升10倍
```

#### 代码修改示例
```c
void MX_TIM2_Init(void)
{
    // ...existing code...
    htim2.Init.Prescaler = 47;           // 降低PSC值
    htim2.Init.Period = 99;              // 提高ARR值 
    // ...existing code...
}
```

### 注意事项与限制

#### 优势 ✅
- **精度提升**: 时间分辨率提高10倍
- **灵活性**: 更多中间值选择
- **稳定性**: 更精确的采样时序
- **扩展性**: 便于后续精细调节

#### 考虑因素 ⚠️
- **功耗**: 略微增加（计数频率更高）
- **ARR限制**: TIM2是32位，最大值4294967295
- **计算复杂度**: 配置计算稍复杂
- **兼容性**: 需要重新验证时序

### 最佳实践建议

1. **对于高精度应用**: 优先选择低PSC高ARR配置
2. **对于低功耗应用**: 可以考虑传统配置
3. **对于需要频繁调节的应用**: 强烈推荐高精度配置
4. **验证方法**: 使用示波器测量实际频率
