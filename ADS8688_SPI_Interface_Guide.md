# ADS8688 SPI 控制接口文档（修正版）

## 概述
本文档提供 ADS8688 16位 8通道 ADC 的 SPI 控制接口完整说明，包含寄存器配置、指令集、通信时序和示例代码。

---

## 一、SPI 接口特性
| 参数             | 值       | 单位 | 说明                     |
|------------------|----------|------|--------------------------|
| 接口类型         | SPI      |      | 兼容标准 4 线 SPI        |
| 时钟模式         | Mode 1   |      | CPOL=0, CPHA=1           |
| 最大 SCLK 频率   | 17       | MHz  | fSAMPLE = 500 kSPS 时    |
| 帧长度           | 16       | bit  | 基本帧长度               |
| 数据顺序         | MSB 优先 |      |                          |

**引脚定义**：
- `CS`：片选（低电平有效）
- `SCLK`：串行时钟
- `SDI`：主机输出，从机输入
- `SDO`：主机输入，从机输出
- `DAISY`：菊花链输入（多设备级联）
- `RST/PD`：复位/掉电控制

---

## 二、指令集（Command Register）
所有指令为 **16 位**，在 `CS` 下降沿后通过 `SDI` 发送：

### 1. 设备控制指令
| 指令名称         | 指令值 (HEX) | 功能说明                             |
|------------------|--------------|--------------------------------------|
| **NO_OP**        | 0000         | 维持当前操作模式                     |
| **STDBY**        | 8200         | 进入待机模式（低功耗）               |
| **PWR_DN**       | 8300         | 进入完全掉电模式                     |
| **RST**          | 8500         | 复位所有程序寄存器                   |
| **FRAME_ABORT**  | 8100         | 中止当前帧操作                       |

### 2. 转换控制指令
| 指令名称         | 指令值 (HEX) | 功能说明                             |
|------------------|--------------|--------------------------------------|
| **AUTO_RST**     | A000         | 启动自动扫描模式                     |
| **MAN_CH0**      | C000         | 手动选择通道 0                       |
| **MAN_CH1**      | C400         | 手动选择通道 1                       |
| **MAN_CH2**      | C800         | 手动选择通道 2                       |
| **MAN_CH3**      | CC00         | 手动选择通道 3                       |
| **MAN_CH4**      | D000         | 手动选择通道 4                       |
| **MAN_CH5**      | D400         | 手动选择通道 5                       |
| **MAN_CH6**      | D800         | 手动选择通道 6                       |
| **MAN_CH7**      | DC00         | 手动选择通道 7                       |
| **MAN_AUX**      | E000         | 手动选择 AUX 通道                    |

### 3. 寄存器访问指令
| 指令名称         | 指令值 (HEX) | 功能说明                             |
|------------------|--------------|--------------------------------------|
| **REG_WRITE**    | 0500         | 寄存器写操作                         |
| **REG_READ**     | 0400         | 寄存器读操作                         |

> **生效时机**：指令在 `CS` 上升沿后生效

---

## 三、程序寄存器配置
### 1. 寄存器地址映射
| 寄存器名称        | 地址 | R/W | 功能描述                 | 复位值 |
|-------------------|------|-----|--------------------------|--------|
| DEVICE_ID         | 00h  | RO  | 设备ID读取               | A0h    |
| AUTO_SEQ_EN       | 01h  | RW  | 自动扫描通道使能         | FFh    |
| CH_PWR_DOWN       | 02h  | RW  | 通道掉电控制             | 00h    |
| FEATURE_SEL       | 03h  | RW  | SDO格式/设备ID           | 00h    |
| CH0_RANGE_SEL     | 05h  | RW  | 通道0输入范围/PGA增益    | 00h    |
| CH1_RANGE_SEL     | 06h  | RW  | 通道1输入范围/PGA增益    | 00h    |
| CH2_RANGE_SEL     | 07h  | RW  | 通道2输入范围/PGA增益    | 00h    |
| CH3_RANGE_SEL     | 08h  | RW  | 通道3输入范围/PGA增益    | 00h    |
| CH4_RANGE_SEL     | 09h  | RW  | 通道4输入范围/PGA增益    | 00h    |
| CH5_RANGE_SEL     | 0Ah  | RW  | 通道5输入范围/PGA增益    | 00h    |
| CH6_RANGE_SEL     | 0Bh  | RW  | 通道6输入范围/PGA增益    | 00h    |
| CH7_RANGE_SEL     | 0Ch  | RW  | 通道7输入范围/PGA增益    | 00h    |
| COMMAND_READBACK  | 3Fh  | RO  | 上一指令回读             | 00h    |

### 2. 关键寄存器详解
**A. 输入范围控制（PGA 增益）**
- **寄存器**：05h-0Ch（每通道独立）
- **位域**：[3:0] `Range_CHn[3:0]`
- **配置表**：
  | 值 (4位) | 输入范围       | PGA 增益 | 满量程 (VREF=4.096V) |
  |----------|----------------|----------|----------------------|
  | 0000     | ±2.5 × VREF    | 1×       | ±10.24 V            |
  | 0001     | ±1.25 × VREF   | 2×       | ±5.12 V             |
  | 0010     | ±0.625 × VREF  | 4×       | ±2.56 V             |
  | 0101     | 0 至 2.5 × VREF| 1×       | 0-10.24 V           |
  | 0110     | 0 至 1.25 × VREF| 2×      | 0-5.12 V            |
  | 其他     | 保留           | -        | -                   |

**B. SDO 输出格式**
- **寄存器**：03h [1:0] `SDO[1:0]`
- **配置表**：
  | 值  | 输出内容                              | 总位数 |
  |-----|---------------------------------------|--------|
  | 00  | 纯转换数据                            | 16     |
  | 01  | 转换数据 + 通道地址                   | 20     |
  | 10  | 转换数据 + 通道地址 + 设备 ID         | 24     |
  | 11  | 转换数据 + 通道地址 + 设备 ID + 范围  | 28     |

**C. 自动扫描配置**
- **寄存器**：01h `AUTO_SEQ_EN`
  - 位 0-7：CH0-CH7 使能位 (1=启用)
  - 位 8：AUX 通道使能位 (1=启用)
- **寄存器**：02h `CH_PWR_DOWN`
  - 位 0-7：CH0-CH7 掉电位 (1=关闭)
  - 位 8：AUX 通道掉电位 (1=关闭)

**D. 设备特征控制**
- **寄存器**：03h `FEATURE_SEL`
  - 位 [7:6]：设备 ID 选择
  - 位 [1:0]：SDO 格式选择
  - 位 [5:2]：保留

---

## 四、SPI 通信时序
### 1. 基本帧结构
```plaintext
        ┌───┐                              ┌───┐
CS      │   │                              │   │
        └───┘                              └───┘
        ┌─────┬───┬───┬───┬───┬───┬───┬───┬─────┐
SCLK    │     │↓ │↑ │↓ │↑ │...│↓ │↑ │↓ │↑ │     │
        └─────┴───┴───┴───┴───┴───┴───┴───┴─────┘
        ┌─────┬───┬───┬───┬───┬───┬───┬───┬─────┐
SDI     │     │15 │14 │13 │12 │...│1  │0  │     │
        └─────┴───┴───┴───┴───┴───┴───┴───┴─────┘
        ┌─────┬───┬───┬───┬───┬───┬───┬───┬─────┐
SDO     │  Hi-Z   │15 │14 │13 │...│1  │0  │ Hi-Z│
        └─────┴───┴───┴───┴───┴───┴───┴───┴─────┘
        ↑           ↑             ↑             ↑
       CS↓       第1个SCLK↓    数据开始       CS↑
       采样启动    指令锁存      输出转换结果
```

### 2. 关键时序参数
| 参数               | 符号       | 最小值 | 最大值 | 单位 | 说明                     |
|--------------------|------------|--------|--------|------|--------------------------|
| SCLK 周期          | t_SCLK     | 59     | -      | ns   | 对应 17 MHz              |
| SCLK 高电平时间    | t_SCLK_H   | 25     | -      | ns   |                          |
| SCLK 低电平时间    | t_SCLK_L   | 25     | -      | ns   |                          |
| CS 低电平时间      | t_CSLOW    | 1.5    | -      | μs   | 32 SCLK 帧 (500 kSPS)   |
| CS 高电平时间      | t_CSHIGH   | 30     | -      | ns   | 帧间隔                   |
| SDI 建立时间       | t_SU_DI    | 5      | -      | ns   | SCLK↓ 前数据稳定         |
| SDI 保持时间       | t_HD_DI    | 5      | -      | ns   | SCLK↓ 后数据保持         |
| SDO 输出延迟       | t_DO_VALID | -      | 10     | ns   | SCLK↓ 后数据有效         |
| SDO 三态延迟       | t_DZ_CSDO  | -      | 10     | ns   | CS↑ 后 SDO 变为高阻     |
| 转换时间           | t_CONV     | 2      | -      | μs   | 单次转换时间             |
| 采样时间           | t_ACQ      | 500    | -      | ns   | 采样保持时间             |

### 3. 寄存器读写时序
**寄存器写操作**：
```plaintext
帧1: REG_WRITE指令 (0500h) + 寄存器地址 (8位)
帧2: 数据值 (8位，左对齐至16位)
```

**寄存器读操作**：
```plaintext
帧1: REG_READ指令 (0400h) + 寄存器地址 (8位)
帧2: 任意数据 → 接收寄存器值 (8位，左对齐至16位)
```

---

## 五、代码示例
### 1. 基础 SPI 函数
```c
// 16位SPI传输
uint16_t spi_transfer_16(uint16_t data) {
    uint16_t result = 0;
    
    cs_low();
    
    // 发送和接收16位数据
    for(int i = 15; i >= 0; i--) {
        // 发送数据位
        if(data & (1 << i)) {
            sdi_high();
        } else {
            sdi_low();
        }
        
        // 时钟上升沿
        sclk_high();
        delay_ns(25);
        
        // 时钟下降沿，读取数据
        sclk_low();
        if(sdo_read()) {
            result |= (1 << i);
        }
        delay_ns(25);
    }
    
    cs_high();
    return result;
}
```

### 2. 寄存器操作函数
```c
// 写寄存器
void ads8688_write_register(uint8_t addr, uint8_t data) {
    // 第一帧：写指令 + 地址
    spi_transfer_16(0x0500 | addr);
    
    // 第二帧：数据（左对齐）
    spi_transfer_16(data << 8);
}

// 读寄存器
uint8_t ads8688_read_register(uint8_t addr) {
    // 第一帧：读指令 + 地址
    spi_transfer_16(0x0400 | addr);
    
    // 第二帧：接收数据
    uint16_t result = spi_transfer_16(0x0000);
    
    return (uint8_t)(result >> 8); // 取高8位
}
```

### 3. 初始化配置
```c
// 完整初始化序列
void ads8688_init(void) {
    // 1. 硬件复位
    rst_pd_low();
    HAL_Delay(1);
    rst_pd_high();
    HAL_Delay(15); // 等待内部参考电压稳定
    
    // 2. 软件复位
    spi_transfer_16(0x8500); // RST指令
    HAL_Delay(1);
    
    // 3. 读取设备ID验证通信
    uint8_t device_id = ads8688_read_register(0x00);
    if(device_id != 0xA0) {
        // 通信错误处理
        return;
    }
    
    // 4. 配置通道范围（通道0设置为±10.24V）
    ads8688_write_register(0x05, 0x00);
    
    // 5. 配置SDO输出格式（纯数据）
    ads8688_write_register(0x03, 0x00);
    
    // 6. 启用自动扫描通道0
    ads8688_write_register(0x01, 0x01);
    
    // 7. 启动自动扫描模式
    spi_transfer_16(0xA000); // AUTO_RST指令
}
```

### 4. 数据采集函数
```c
// 读取ADC转换结果
uint16_t ads8688_read_data(void) {
    // 发送NO_OP指令并接收数据
    return spi_transfer_16(0x0000);
}

// 自动扫描模式数据采集
void ads8688_auto_scan(void) {
    uint16_t adc_data;
    
    while(1) {
        // 读取转换结果
        adc_data = ads8688_read_data();
        
        // 处理数据
        process_adc_data(adc_data);
        
        // 等待下一次采样
        HAL_Delay(1); // 1ms间隔
    }
}

// 手动通道选择
uint16_t ads8688_read_channel(uint8_t channel) {
    uint16_t cmd = 0xC000 + (channel << 10); // MAN_CHn指令
    
    // 发送通道选择指令
    spi_transfer_16(cmd);
    
    // 等待转换完成
    HAL_Delay(1);
    
    // 读取转换结果
    return spi_transfer_16(0x0000);
}
```

### 5. 错误处理和诊断
```c
// 通信测试函数
bool ads8688_communication_test(void) {
    // 读取设备ID
    uint8_t device_id = ads8688_read_register(0x00);
    
    if(device_id != 0xA0) {
        return false; // 通信失败
    }
    
    // 测试寄存器读写
    uint8_t test_value = 0x55;
    ads8688_write_register(0x05, test_value);
    uint8_t read_value = ads8688_read_register(0x05);
    
    if(read_value != test_value) {
        return false; // 读写失败
    }
    
    return true; // 通信正常
}

// 获取上一条指令
uint8_t ads8688_get_last_command(void) {
    return ads8688_read_register(0x3F);
}
```

---

## 六、工作模式详解
### 1. 自动扫描模式
**特点**：
- 自动循环扫描启用的通道
- 连续转换，无需手动触发
- 适合多通道监控应用

**配置步骤**：
1. 设置 `AUTO_SEQ_EN` 寄存器启用所需通道
2. 发送 `AUTO_RST` 指令启动扫描
3. 持续发送 `NO_OP` 指令读取数据

### 2. 手动通道模式
**特点**：
- 手动选择单个通道转换
- 按需转换，节省功耗
- 适合偶发性采样应用

**使用方法**：
1. 发送 `MAN_CHn` 指令选择通道
2. 等待转换完成
3. 发送 `NO_OP` 指令读取数据

### 3. 功耗管理模式
**STANDBY 模式**：
- 发送 `STDBY` 指令
- 保持寄存器状态
- 唤醒时间 < 20μs

**POWER_DOWN 模式**：
- 发送 `PWR_DN` 指令
- 最低功耗状态
- 唤醒时间 = 15ms

---

## 七、菊花链配置
### 1. 连接拓扑
```plaintext
Host ──CS/SCLK──► ADC1 ──SDO──► ADC2 ──SDO──► ... ──SDO──► Host
      │          │          │                  │
      └SDI──────┘          └SDI───────────────┘
                  DAISY=GND            DAISY=SDO_prev
```

### 2. 配置步骤
1. **第一个设备**：DAISY 接地
2. **后续设备**：DAISY 接前一个设备的 SDO
3. **设备ID配置**：通过 `FEATURE_SEL` 寄存器设置不同 ID
4. **数据帧长度**：根据设备数量调整接收帧长度

---

## 八、注意事项
### 1. 上电时序
```plaintext
VDD稳定 → RST/PD保持高电平 → 等待15ms → 初始化寄存器 → 启动转换
```

### 2. 模式切换延迟
| 模式切换       | 最小延迟 | 说明                |
|----------------|----------|---------------------|
| PWR_DN → 工作  | 15 ms    | 内部参考电压稳定时间|
| STDBY → 工作   | 20 μs    | 模拟前端启动时间    |
| 工作 → STDBY   | 0 μs     | 立即生效            |

### 3. 输入保护和限制
- **过压保护**：±20V（AVDD=5V时）
- **输入阻抗**：1MΩ 恒定
- **超量程输出**：0x0000（负饱和）或 0xFFFF（正饱和）

### 4. 时钟要求
- **SCLK频率**：最大 17MHz
- **占空比**：45%-55%
- **时钟抖动**：< 1ns RMS

### 5. 布局建议
- **数字地和模拟地分离**
- **SCLK走线尽量短**
- **电源去耦电容靠近芯片**
- **输入信号屏蔽**

---

## 九、故障诊断
### 1. 常见问题
| 问题症状 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 读不到设备ID | 连线错误/电源问题 | 检查连线和电源 |
| 数据全0或全1 | 输入超量程/参考电压异常 | 检查输入范围配置 |
| 数据不稳定 | 时钟问题/噪声干扰 | 检查时钟质量和PCB布局 |
| 转换速度慢 | 模式配置错误 | 确认工作模式设置 |

### 2. 调试步骤
1. **硬件检查**：电源、连线、时钟
2. **通信测试**：读取设备ID
3. **寄存器验证**：读写测试寄存器
4. **功能测试**：单通道手动转换
5. **性能测试**：多通道自动扫描

---

## 十、性能优化
### 1. 提高采样率
- 使用自动扫描模式
- 优化SPI时钟频率
- 减少不必要的寄存器操作

### 2. 降低功耗
- 关闭不用的通道
- 使用STANDBY模式
- 优化采样频率

### 3. 提高精度
- 选择合适的输入范围
- 保证参考电压稳定
- 注意PCB布局和屏蔽

---

## 十一、参考文档
1. **ADS8688 数据手册** - TI 官方文档 SBAS582C
2. **寄存器映射表**：数据手册 Table 9 (Page 45)
3. **指令集定义**：数据手册 Table 6 (Page 43)
4. **时序图**：数据手册 Figure 28 (Page 10)
5. **应用笔记**：SLAA704 - ADS8688 设计指南

> **建议**：结合数据手册第 8 章 "Detailed Description" 和第 9 章 "Application and Implementation" 使用本指南

---

## 版本历史
| 版本 | 日期 | 修改内容 |
|------|------|----------|
| 1.0  | 2025-07-04 | 初始版本 |
| 1.1  | 2025-07-04 | 修正寄存器操作格式和时序参数 |
