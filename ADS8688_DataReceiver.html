<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADS8688 æ•°æ®æ¥æ”¶å™¨ - å®æ—¶ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: #f5f5f5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .controls,
        .status,
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .control-group,
        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status {
            gap: 10px;
            font-size: 0.95em;
            background: #f8f9fa;
            padding: 4px 0;
        }

        .status-value {
            font-weight: bold;
            color: #007bff;
        }

        .chart-container {
            margin-bottom: 10px;
            height: 300px;
        }

        #dataInput {
            width: 100%;
            height: 120px;
            font-family: monospace;
            font-size: 12px;
        }

        button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 5px 12px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 4px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .alert {
            padding: 6px;
            margin-bottom: 8px;
            border-radius: 3px;
            font-size: 0.95em;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }

        .tabs {
            margin-bottom: 8px;
        }

        .tab {
            padding: 6px 12px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            cursor: pointer;
            margin-right: 2px;
            border-radius: 3px 3px 0 0;
            font-size: 0.98em;
        }

        .tab.active {
            background: #fff;
            border-bottom: 1px solid #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.97em;
        }

        th,
        td {
            padding: 4px;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }

        .channel-selector {
            margin-bottom: 4px;
        }

        .channel-selector label {
            margin-right: 8px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ ADS8688 æ•°æ®æ¥æ”¶å™¨</h1>
            <p>å®æ—¶ç›‘æ§é‡‡æ ·æ•°æ®ï¼ŒéªŒè¯é‡‡æ ·ç‡å’Œæ•°æ®å®Œæ•´æ€§</p>
            <p style="font-size: 0.9em; color: #666;">âš¡ æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ - æœ€å¤šå­˜å‚¨1200ä¸ªæ•°æ®ç‚¹ï¼Œæ— åŠ¨ç”»æ•ˆæœ</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="serialPort">ä¸²å£:</label>
                <button id="connectBtn">è¿æ¥ä¸²å£</button>
                <button id="disconnectBtn" disabled>æ–­å¼€è¿æ¥</button>
            </div>
            <div class="control-group">
                <button id="clearBtn">æ¸…ç©ºæ•°æ®</button>
                <button id="exportBtn">å¯¼å‡ºæ•°æ®</button>
                <button id="pauseBtn">æš‚åœæ›´æ–°</button>
            </div>
            <div class="control-group">
                <label>é‡‡æ ·ç‡è®¾ç½®:</label>
                <input type="number" id="expectedRate" value="1200" min="1" max="1200000" style="width: 100px;">
                <span>Hz</span>
            </div>
        </div>

        <div class="status">
            <div class="status-item">
                <div class="status-value" id="connectionStatus">æœªè¿æ¥</div>
                <div class="status-label">è¿æ¥çŠ¶æ€</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="dataPackets">0</div>
                <div class="status-label">æ•°æ®åŒ…æ•°</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="totalSamples">0</div>
                <div class="status-label">æ€»é‡‡æ ·ç‚¹</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="actualRate">0</div>
                <div class="status-label">å®é™…é‡‡æ ·ç‡ (Hz)</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="lostSamples">0</div>
                <div class="status-label">ä¸¢å¤±é‡‡æ ·ç‚¹</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="storedPoints">0</div>
                <div class="status-label">å­˜å‚¨ç‚¹æ•°</div>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="tabs">
            <div class="tab active" data-tab="chart">å®æ—¶å›¾è¡¨</div>
            <div class="tab" data-tab="data">æ•°æ®è¡¨æ ¼</div>
            <div class="tab" data-tab="analysis">æ•°æ®åˆ†æ</div>
            <div class="tab" data-tab="input">æ‰‹åŠ¨è¾“å…¥</div>
        </div>

        <div id="chartTab" class="tab-content active">
            <div class="channel-selector">
                <label><input type="checkbox" id="ch0" checked> CH0</label>
                <label><input type="checkbox" id="ch1" checked> CH1</label>
                <label><input type="checkbox" id="ch2"> CH2</label>
                <label><input type="checkbox" id="ch3"> CH3</label>
                <label><input type="checkbox" id="ch4"> CH4</label>
                <label><input type="checkbox" id="ch5"> CH5</label>
                <label><input type="checkbox" id="ch6"> CH6</label>
                <label><input type="checkbox" id="ch7"> CH7</label>
            </div>
            <div class="chart-container">
                <canvas id="dataChart"></canvas>
            </div>
        </div>

        <div id="dataTab" class="tab-content">
            <div class="data-table">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>Index</th>
                            <th>CH0(V)</th>
                            <th>CH1(V)</th>
                            <th>CH2(V)</th>
                            <th>CH3(V)</th>
                            <th>CH4(V)</th>
                            <th>CH5(V)</th>
                            <th>CH6(V)</th>
                            <th>CH7(V)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="analysisTab" class="tab-content">
            <div class="chart-container">
                <canvas id="analysisChart"></canvas>
            </div>
            <div style="margin-bottom:8px;">
                <label>åˆ†æé€šé“:
                    <select id="fftChannel">
                        <option value="0">CH0</option>
                        <option value="1">CH1</option>
                        <option value="2">CH2</option>
                        <option value="3">CH3</option>
                        <option value="4">CH4</option>
                        <option value="5">CH5</option>
                        <option value="6">CH6</option>
                        <option value="7">CH7</option>
                    </select>
                </label>
                <label style="margin-left:10px;">ä¿¡å·é¢‘ç‡(Hz):
                    <input type="number" id="signalFreq" value="1200" min="1" max="1200000" style="width:80px;">
                </label>
                <button id="fftAnalyzeBtn">FFTåˆ†æé‡‡æ ·ç‡</button>
            </div>
            <div id="analysisResults"></div>
        </div>

        <div id="inputTab" class="tab-content">
            <div class="data-input">
                <h3>æ‰‹åŠ¨è¾“å…¥FFTåˆ†ææ•°æ®</h3>
                <p>è¯·ç²˜è´´ä¸€åŒ…å®Œæ•´çš„ADS8688å¯¼å‡ºæ•°æ®ï¼ˆå«è¡¨å¤´ï¼‰ï¼Œé€‰æ‹©é€šé“åç‚¹å‡»â€œé¢‘è°±åˆ†æâ€ï¼š</p>
                <textarea id="fftInput" placeholder="ç²˜è´´ä¸€åŒ…æ•°æ®,å¦‚data.txtå†…å®¹..." style="width:100%;height:180px;"></textarea>
                <div style="margin:8px 0;">
                    <label>åˆ†æé€šé“:
                        <select id="fftInputChannel">
                            <option value="0">CH0</option>
                            <option value="1">CH1</option>
                            <option value="2">CH2</option>
                            <option value="3">CH3</option>
                            <option value="4">CH4</option>
                            <option value="5">CH5</option>
                            <option value="6">CH6</option>
                            <option value="7">CH7</option>
                        </select>
                    </label>
                    <label style="margin-left:10px;">ä¿¡å·é¢‘ç‡(Hz):
                        <input type="number" id="fftInputSignalFreq" value="1000" min="1" max="1000000" style="width:80px;">
                    </label>
                    <button id="fftInputAnalyzeBtn">é¢‘è°±åˆ†æ</button>
                </div>
                <div class="chart-container" style="height:220px;">
                    <canvas id="fftInputChart"></canvas>
                </div>
                <div id="fftInputResult"></div>
            </div>
        </div>

        <script>
        // æ‰‹åŠ¨FFTåˆ†æåŠŸèƒ½
        function analyzeFFTInput() {
            const txt = document.getElementById('fftInput').value;
            const ch = parseInt(document.getElementById('fftInputChannel').value);
            const freq = parseFloat(document.getElementById('fftInputSignalFreq').value);
            const lines = txt.split(/\r?\n/);
            let data = [];
            for(let line of lines) {
                if(line.startsWith('Index')||line.startsWith('===')||!line.trim()) continue;
                const parts = line.split(',');
                if(parts.length>=9) {
                    // ä¿®æ­£: æ•°æ®æ ¼å¼ä¸º Index,CH0,CH1,... parts[0]æ˜¯Index, parts[1]æ˜¯CH0, å› æ­¤é€šé“chçš„æ•°æ®åœ¨parts[1+ch]
                    let v = parseFloat(parts[1 + ch]);
                    if(!isNaN(v)) data.push(v);
                }
            }

            if(!window.FFT || data.length < 16) {
                document.getElementById('fftInputResult').innerHTML = '<span style="color:#f00">æ•°æ®ä¸è¶³æˆ–FFTåº“æœªåŠ è½½</span>';
                return;
            }
            // å–2çš„å¹‚é•¿åº¦
            let N = 1; while(N<data.length) N*=2; N/=2; N=Math.max(16,N);
            data = data.slice(0,N);
            // å»å‡å€¼
            let mean = data.reduce((a,b)=>a+b,0)/data.length;
            let arr = data.map(x=>x-mean);
            let fft = new FFT(N);
            let re = arr.slice();
            let im = new Array(N).fill(0);
            fft.transform(re, im);
            let mags = re.map((r,i)=>Math.sqrt(r*r+im[i]*im[i]));
            // åªçœ‹å‰N/2
            let maxIdx = 1;
            for(let i=2;i<N/2;i++) if(mags[i]>mags[maxIdx]) maxIdx=i;
            let peak = mags[maxIdx];
            let peakFreqBin = maxIdx;
            // é‡‡æ ·ç‡åæ¨
            let fs = freq * N / peakFreqBin;
            let msg = `ä¸»å³°Bin: ${peakFreqBin}ï¼Œä¸»é¢‘å¹…å€¼: ${peak.toFixed(2)}<br>åæ¨é‡‡æ ·ç‡: <b>${fs.toFixed(2)} Hz</b> (è¾“å…¥ä¿¡å·: ${freq} Hz)`;
            document.getElementById('fftInputResult').innerHTML = msg;
            // ç”»é¢‘è°±
            let ctx = document.getElementById('fftInputChart').getContext('2d');
            if(window.fftInputChartObj) window.fftInputChartObj.destroy();
            window.fftInputChartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length:N/2},(_,i)=>i),
                    datasets: [{label:'å¹…å€¼',data:mags.slice(0,N/2),borderColor:'#007bff',pointRadius:0}]
                },
                options: {
                    responsive:true,maintainAspectRatio:false,
                    plugins:{legend:{display:false}},
                    scales:{x:{title:{display:true,text:'Bin'}},y:{title:{display:true,text:'å¹…å€¼'}}},
                    animation:false
                }
            });
        }
        </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fft.js/dist/fft.min.js"></script>
    <script>
        class ADS8688DataReceiver {
            fftBuffer = [];
            fftChannel = 0;
            inPacket = false;
            constructor() {
                this.port = null;
                this.reader = null;
                this.decoder = new TextDecoder();
                this.buffer = '';
                this.isConnected = false;
                this.isPaused = false;
                this.dataPackets = 0;
                this.totalSamples = 0;
                this.expectedSampleRate = 1200;
                this.actualSampleRate = 0;
                this.lostSamples = 0;
                this.lastSampleTime = 0;
                this.sampleTimes = [];
                this.allData = [];
                this.maxStoragePoints = 1200;  // æœ€å¤§å­˜å‚¨ç‚¹æ•°
                this.maxDisplayPoints = 1200;  // æœ€å¤§æ˜¾ç¤ºç‚¹æ•°

                this.initChart();
                this.initAnalysisChart();
                this.bindEvents();
            }

            initChart() {
                const ctx = document.getElementById('dataChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'CH0 (V)',
                                data: [],
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.1
                            },
                            {
                                label: 'CH1 (V)',
                                data: [],
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                tension: 0.1
                            },
                            {
                                label: 'CH2 (V)',
                                data: [],
                                borderColor: 'rgb(255, 205, 86)',
                                backgroundColor: 'rgba(255, 205, 86, 0.2)',
                                tension: 0.1,
                                hidden: true
                            },
                            {
                                label: 'CH3 (V)',
                                data: [],
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1,
                                hidden: true
                            },
                            {
                                label: 'CH4 (V)',
                                data: [],
                                borderColor: 'rgb(153, 102, 255)',
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                tension: 0.1,
                                hidden: true
                            },
                            {
                                label: 'CH5 (V)',
                                data: [],
                                borderColor: 'rgb(255, 159, 64)',
                                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                tension: 0.1,
                                hidden: true
                            },
                            {
                                label: 'CH6 (V)',
                                data: [],
                                borderColor: 'rgb(199, 199, 199)',
                                backgroundColor: 'rgba(199, 199, 199, 0.2)',
                                tension: 0.1,
                                hidden: true
                            },
                            {
                                label: 'CH7 (V)',
                                data: [],
                                borderColor: 'rgb(83, 102, 255)',
                                backgroundColor: 'rgba(83, 102, 255, 0.2)',
                                tension: 0.1,
                                hidden: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ADS8688 å®æ—¶æ•°æ®'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'é‡‡æ ·ç‚¹'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'ç”µå‹ (V)'
                                }
                            }
                        },
                        animation: false,  // å®Œå…¨ç¦ç”¨åŠ¨ç”»
                        interaction: {
                            intersect: false
                        },
                        elements: {
                            point: {
                                radius: 0  // éšè—æ•°æ®ç‚¹ï¼Œæé«˜æ€§èƒ½
                            }
                        }
                    }
                });
            }

            initAnalysisChart() {
                const ctx = document.getElementById('analysisChart').getContext('2d');
                this.analysisChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'é‡‡æ ·ç‡ (Hz)',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'å®é™…é‡‡æ ·ç‡ç›‘æ§'
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'é‡‡æ ·ç‡ (Hz)'
                                }
                            }
                        },
                        animation: false,  // ç¦ç”¨åŠ¨ç”»
                        elements: {
                            point: {
                                radius: 0  // éšè—æ•°æ®ç‚¹
                            }
                        }
                    }
                });
            }

            bindEvents() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connectSerial());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnectSerial());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearData());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());
                document.getElementById('expectedRate').addEventListener('change', (e) => {
                    this.expectedSampleRate = parseInt(e.target.value);
                });

                // æ ‡ç­¾é¡µåˆ‡æ¢
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // é€šé“é€‰æ‹©
                for (let i = 0; i < 8; i++) {
                    document.getElementById(`ch${i}`).addEventListener('change', (e) => {
                        this.chart.data.datasets[i].hidden = !e.target.checked;
                        // ä½¿ç”¨ 'none' æ¨¡å¼æ›´æ–°ï¼Œé¿å…åŠ¨ç”»
                        this.chart.update('none');
                    });
                }
            }

            async connectSerial() {
                if (!('serial' in navigator)) {
                    this.showAlert('error', 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Serial APIã€‚è¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ã€‚');
                    return;
                }

                try {
                    this.port = await navigator.serial.requestPort();
                    await this.port.open({ baudRate: 115200 });

                    this.isConnected = true;
                    this.updateConnectionStatus();
                    this.showAlert('success', 'ä¸²å£è¿æ¥æˆåŠŸï¼');

                    this.startReading();
                } catch (error) {
                    this.showAlert('error', `è¿æ¥å¤±è´¥: ${error.message}`);
                }
            }

            async disconnectSerial() {
                if (this.port) {
                    if (this.reader) {
                        await this.reader.cancel();
                    }
                    await this.port.close();
                    this.port = null;
                    this.reader = null;
                    this.isConnected = false;
                    this.updateConnectionStatus();
                    this.showAlert('success', 'ä¸²å£å·²æ–­å¼€');
                }
            }

            async startReading() {
                if (!this.port) return;

                try {
                    this.reader = this.port.readable.getReader();

                    while (this.isConnected) {
                        const { value, done } = await this.reader.read();
                        if (done) break;

                        const text = this.decoder.decode(value);
                        this.buffer += text;
                        this.processBuffer();
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        this.showAlert('error', `è¯»å–æ•°æ®å¤±è´¥: ${error.message}`);
                    }
                } finally {
                    if (this.reader) {
                        this.reader.releaseLock();
                    }
                }
            }

            processBuffer() {
                const lines = this.buffer.split('\n');
                this.buffer = lines.pop() || '';

                for (const line of lines) {
                    this.processLine(line.trim());
                }
            }

            processLine(line) {
                if (line.includes('=== ADS8688 History Data')) {
                    this.dataPackets++;
                    this.inPacket = true;
                    this.fftBuffer = [];
                    this.updateStatus();
                    return;
                }
                if (line.includes('Index,CH0')) {
                    // è¡¨å¤´ï¼Œè·³è¿‡
                    return;
                }
                if (line.includes('=== End of History Data')) {
                    this.inPacket = false;
                    this.calculateSampleRate();
                    // åŒ…ç»“æŸæ—¶è‡ªåŠ¨åšä¸€æ¬¡FFTåˆ†æï¼ˆå¯é€‰ï¼‰
                    doFFTAnalyze();
                    return;
                }
                // åªåœ¨åŒ…å†…æ”¶é›†æ•°æ®
                if (!this.inPacket) return;
                // å¤„ç†æ•°æ®è¡Œ
                const parts = line.split(',');
                if (parts.length >= 9) {
                    const index = parseInt(parts[0]);
                    const data = {
                        timestamp: Date.now(),
                        index: index,
                        ch0: parseFloat(parts[1]),
                        ch1: parseFloat(parts[2]),
                        ch2: parseFloat(parts[3]),
                        ch3: parseFloat(parts[4]),
                        ch4: parseFloat(parts[5]),
                        ch5: parseFloat(parts[6]),
                        ch6: parseFloat(parts[7]),
                        ch7: parseFloat(parts[8])
                    };
                    this.allData.push(data);
                    this.totalSamples++;
                    // åªæ”¶é›†å½“å‰åŒ…çš„fftBuffer
                    let ch = this.fftChannel || 0;
                    let v = data['ch' + ch];
                    this.fftBuffer.push(v);
                    // é™åˆ¶å­˜å‚¨çš„æ•°æ®ç‚¹æ•°é‡ï¼Œä¿æŒæœ€æ–°çš„1200ä¸ªç‚¹
                    if (this.allData.length > this.maxStoragePoints) {
                        this.allData.shift();
                    }
                    if (!this.isPaused) {
                        this.updateChart(data);
                        this.updateDataTable(data);
                    }
                }
                // FFTåˆ†æé‡‡æ ·ç‡
                function doFFTAnalyze() {
                    const ch = parseInt(document.getElementById('fftChannel').value);
                    const freq = parseFloat(document.getElementById('signalFreq').value);
                    const buf = receiver.fftBuffer || [];
                    if (!window.FFT || !buf || buf.length < 512) {
                        document.getElementById('analysisResults').innerHTML = '<span style="color:#f00">é‡‡æ ·ç‚¹ä¸è¶³512æˆ–FFTåº“æœªåŠ è½½</span>';
                        return;
                    }
                    // å–æœ€æ–°512ç‚¹
                    let data = buf.slice(-512);
                    // å»å‡å€¼
                    let mean = data.reduce((a, b) => a + b, 0) / data.length;
                    let arr = data.map(x => x - mean);
                    let fft = new FFT(512);
                    let re = arr.slice();
                    let im = new Array(512).fill(0);
                    fft.transform(re, im);
                    let mags = re.map((r, i) => Math.sqrt(r * r + im[i] * im[i]));
                    // åªçœ‹å‰256
                    let maxIdx = 1;
                    for (let i = 2; i < 256; i++) if (mags[i] > mags[maxIdx]) maxIdx = i;
                    let peak = mags[maxIdx];
                    let peakFreqBin = maxIdx;
                    // é‡‡æ ·ç‡åæ¨
                    let fs = freq * 512 / peakFreqBin;
                    let msg = `ä¸»å³°Bin: ${peakFreqBin}ï¼Œä¸»é¢‘å¹…å€¼: ${peak.toFixed(2)}<br>åæ¨é‡‡æ ·ç‡: <b>${fs.toFixed(2)} Hz</b> (è¾“å…¥ä¿¡å·: ${freq} Hz)`;
                    document.getElementById('analysisResults').innerHTML = msg;
                }

                document.addEventListener('DOMContentLoaded', function () {
                    document.getElementById('fftAnalyzeBtn').onclick = doFFTAnalyze;
                    document.getElementById('fftChannel').onchange = function () {
                        receiver.fftChannel = parseInt(this.value);
                    };
                    // Bind manual FFT analysis button
                    document.getElementById('fftInputAnalyzeBtn').onclick = analyzeFFTInput;
                });
            }

            updateChart(data) {
                const chartData = this.chart.data;

                // é™åˆ¶æ˜¾ç¤ºç‚¹æ•°ï¼Œä¿æŒæœ€æ–°çš„1200ä¸ªç‚¹
                if (chartData.labels.length >= this.maxDisplayPoints) {
                    chartData.labels.shift();
                    chartData.datasets.forEach(dataset => dataset.data.shift());
                }

                chartData.labels.push(data.index);
                chartData.datasets[0].data.push(data.ch0);
                chartData.datasets[1].data.push(data.ch1);
                chartData.datasets[2].data.push(data.ch2);
                chartData.datasets[3].data.push(data.ch3);
                chartData.datasets[4].data.push(data.ch4);
                chartData.datasets[5].data.push(data.ch5);
                chartData.datasets[6].data.push(data.ch6);
                chartData.datasets[7].data.push(data.ch7);

                // ä½¿ç”¨ 'none' æ¨¡å¼æ›´æ–°ï¼Œå®Œå…¨è·³è¿‡åŠ¨ç”»
                this.chart.update('none');
            }

            updateDataTable(data) {
                const tableBody = document.getElementById('dataTableBody');
                const row = tableBody.insertRow(0);

                row.insertCell(0).textContent = new Date(data.timestamp).toLocaleTimeString();
                row.insertCell(1).textContent = data.index;
                row.insertCell(2).textContent = data.ch0.toFixed(4);
                row.insertCell(3).textContent = data.ch1.toFixed(4);
                row.insertCell(4).textContent = data.ch2.toFixed(4);
                row.insertCell(5).textContent = data.ch3.toFixed(4);
                row.insertCell(6).textContent = data.ch4.toFixed(4);
                row.insertCell(7).textContent = data.ch5.toFixed(4);
                row.insertCell(8).textContent = data.ch6.toFixed(4);
                row.insertCell(9).textContent = data.ch7.toFixed(4);

                // é™åˆ¶è¡¨æ ¼è¡Œæ•°ä¸º50ï¼Œå‡å°‘DOMå…ƒç´ æ•°é‡
                while (tableBody.rows.length > 50) {
                    tableBody.deleteRow(-1);
                }
            }

            calculateSampleRate() {
                const now = Date.now();
                this.sampleTimes.push(now);

                // ä¿æŒæœ€è¿‘10ä¸ªæ•°æ®åŒ…çš„æ—¶é—´
                if (this.sampleTimes.length > 10) {
                    this.sampleTimes.shift();
                }

                if (this.sampleTimes.length >= 2) {
                    const timeDiff = (now - this.sampleTimes[0]) / 1200; // ç§’
                    const sampleCount = (this.sampleTimes.length - 1) * 512; // æ¯åŒ…512ä¸ªæ ·æœ¬
                    this.actualSampleRate = Math.round(sampleCount / timeDiff);
                }

                this.updateAnalysisChart();
            }

            updateAnalysisChart() {
                const now = new Date().toLocaleTimeString();
                const analysisData = this.analysisChart.data;

                // é™åˆ¶åˆ†æå›¾è¡¨ç‚¹æ•°ä¸º30ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨
                if (analysisData.labels.length >= 30) {
                    analysisData.labels.shift();
                    analysisData.datasets[0].data.shift();
                }

                analysisData.labels.push(now);
                analysisData.datasets[0].data.push(this.actualSampleRate);

                // ä½¿ç”¨ 'none' æ¨¡å¼æ›´æ–°ï¼Œè·³è¿‡åŠ¨ç”»
                this.analysisChart.update('none');
            }

            updateStatus() {
                document.getElementById('dataPackets').textContent = this.dataPackets;
                document.getElementById('totalSamples').textContent = this.totalSamples;
                document.getElementById('actualRate').textContent = this.actualSampleRate;
                document.getElementById('lostSamples').textContent = this.lostSamples;
                document.getElementById('storedPoints').textContent = this.allData.length;
            }

            updateConnectionStatus() {
                const status = document.getElementById('connectionStatus');
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');

                if (this.isConnected) {
                    status.textContent = 'å·²è¿æ¥';
                    status.style.color = '#28a745';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                } else {
                    status.textContent = 'æœªè¿æ¥';
                    status.style.color = '#dc3545';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                }
            }

            clearData() {
                this.allData = [];
                this.totalSamples = 0;
                this.dataPackets = 0;
                this.actualSampleRate = 0;
                this.lostSamples = 0;
                this.sampleTimes = [];

                this.chart.data.labels = [];
                this.chart.data.datasets.forEach(dataset => dataset.data = []);
                this.chart.update();

                this.analysisChart.data.labels = [];
                this.analysisChart.data.datasets[0].data = [];
                this.analysisChart.update();

                document.getElementById('dataTableBody').innerHTML = '';
                this.updateStatus();

                this.showAlert('success', 'æ•°æ®å·²æ¸…ç©º');
            }

            exportData() {
                if (this.allData.length === 0) {
                    this.showAlert('warning', 'æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                    return;
                }

                const csv = this.dataToCSV();
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ADS8688_data_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                this.showAlert('success', 'æ•°æ®å¯¼å‡ºæˆåŠŸ');
            }

            dataToCSV() {
                const headers = ['Timestamp', 'Index', 'CH0(V)', 'CH1(V)', 'CH2(V)', 'CH3(V)', 'CH4(V)', 'CH5(V)', 'CH6(V)', 'CH7(V)'];
                const rows = this.allData.map(data => [
                    new Date(data.timestamp).toISOString(),
                    data.index,
                    data.ch0,
                    data.ch1,
                    data.ch2,
                    data.ch3,
                    data.ch4,
                    data.ch5,
                    data.ch6,
                    data.ch7
                ]);

                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                const btn = document.getElementById('pauseBtn');
                btn.textContent = this.isPaused ? 'ç»§ç»­æ›´æ–°' : 'æš‚åœæ›´æ–°';
                btn.style.backgroundColor = this.isPaused ? '#dc3545' : '#007bff';
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}Tab`).classList.add('active');
            }

            showAlert(type, message) {
                const alertContainer = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;

                alertContainer.appendChild(alert);

                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }

        // æ‰‹åŠ¨å¤„ç†æ•°æ®å‡½æ•°
        function processManualData() {
            const input = document.getElementById('dataInput').value;
            const lines = input.split('\n');

            for (const line of lines) {
                receiver.processLine(line.trim());
            }

            receiver.showAlert('success', 'æ‰‹åŠ¨æ•°æ®å¤„ç†å®Œæˆ');
        }

        // åˆå§‹åŒ–åº”ç”¨
        const receiver = new ADS8688DataReceiver();

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºä½¿ç”¨è¯´æ˜
        window.addEventListener('load', () => {
            receiver.showAlert('success', 'ğŸ‰ ADS8688æ•°æ®æ¥æ”¶å™¨å·²å¯åŠ¨ï¼ç‚¹å‡»"è¿æ¥ä¸²å£"å¼€å§‹æ¥æ”¶æ•°æ®ã€‚');
        });
    </script>
</body>

</html>